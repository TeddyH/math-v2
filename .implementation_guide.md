# 초등수학 앱 구현 가이드

## 주요 Enum 정의
```dart
enum OperationType { addition, subtraction, multiplication, division, random }
enum Difficulty { oneDigit, twoDigit, threeDigit }
enum GameMode { classic, airplane }
enum GameState { waiting, playing, paused, gameOver }
```

## 핵심 모델 클래스

### UserInfo 모델
```dart
class UserInfo {
  final String school;
  final int grade;
  final String nickname;
  final String deviceId;
  
  UserInfo({
    required this.school,
    required this.grade,
    required this.nickname,
    required this.deviceId,
  });
  
  Map<String, dynamic> toJson() => {
    'school': school,
    'grade': grade,
    'nickname': nickname,
    'deviceId': deviceId,
  };
  
  factory UserInfo.fromJson(Map<String, dynamic> json) => UserInfo(
    school: json['school'],
    grade: json['grade'],
    nickname: json['nickname'],
    deviceId: json['deviceId'],
  );
}
```

### MathProblem 모델
```dart
class MathProblem {
  final int operand1;
  final int operand2;
  final OperationType operation;
  final int correctAnswer;
  final List<int> options; // 정답 1개 + 오답 2개
  final Difficulty difficulty;
  
  MathProblem({
    required this.operand1,
    required this.operand2,
    required this.operation,
    required this.correctAnswer,
    required this.options,
    required this.difficulty,
  });
  
  String get displayProblem {
    String op = '';
    switch (operation) {
      case OperationType.addition: op = '+'; break;
      case OperationType.subtraction: op = '-'; break;
      case OperationType.multiplication: op = '×'; break;
      case OperationType.division: op = '÷'; break;
      default: op = '?';
    }
    return '$operand1 $op $operand2 = ?';
  }
}
```

### GameScore 모델
```dart
class GameScore {
  final UserInfo user;
  final int score;
  final GameMode mode;
  final DateTime timestamp;
  final int problemsSolved;
  final OperationType operationType;
  final Difficulty difficulty;
  
  GameScore({
    required this.user,
    required this.score,
    required this.mode,
    required this.timestamp,
    required this.problemsSolved,
    required this.operationType,
    required this.difficulty,
  });
  
  Map<String, dynamic> toLeaderboardData() => {
    'school': user.school,
    'grade': user.grade,
    'nickname': user.nickname,
    'score': score,
    'mode': mode.toString(),
    'timestamp': timestamp.millisecondsSinceEpoch,
  };
}
```

## 게임 로직 핵심 구현

### 문제 생성기
```dart
class ProblemGenerator {
  static MathProblem generate(OperationType type, Difficulty difficulty) {
    final random = Random();
    
    // 난이도별 숫자 범위 설정
    int maxNumber = switch (difficulty) {
      Difficulty.oneDigit => 9,
      Difficulty.twoDigit => 99,
      Difficulty.threeDigit => 999,
    };
    
    int operand1 = random.nextInt(maxNumber) + 1;
    int operand2 = random.nextInt(maxNumber) + 1;
    
    // 나눗셈의 경우 나머지가 0이 되도록 조정
    if (type == OperationType.division) {
      operand1 = operand2 * (random.nextInt(maxNumber ~/ operand2) + 1);
    }
    
    int correctAnswer = switch (type) {
      OperationType.addition => operand1 + operand2,
      OperationType.subtraction => operand1 - operand2,
      OperationType.multiplication => operand1 * operand2,
      OperationType.division => operand1 ~/ operand2,
      OperationType.random => throw UnimplementedError(),
    };
    
    // 오답 생성 (정답 ±1~5 범위에서 2개)
    List<int> options = [correctAnswer];
    while (options.length < 3) {
      int wrongAnswer = correctAnswer + (random.nextInt(10) - 5);
      if (wrongAnswer > 0 && !options.contains(wrongAnswer)) {
        options.add(wrongAnswer);
      }
    }
    options.shuffle();
    
    return MathProblem(
      operand1: operand1,
      operand2: operand2,
      operation: type,
      correctAnswer: correctAnswer,
      options: options,
      difficulty: difficulty,
    );
  }
}
```

### 점수 계산기
```dart
class ScoreCalculator {
  static const Map<OperationType, int> baseScore = {
    OperationType.addition: 10,
    OperationType.subtraction: 15,
    OperationType.multiplication: 20,
    OperationType.division: 25,
    OperationType.random: 30,
  };
  
  static const Map<Difficulty, double> difficultyMultiplier = {
    Difficulty.oneDigit: 1.0,
    Difficulty.twoDigit: 1.5,
    Difficulty.threeDigit: 2.0,
  };
  
  static int calculateScore(OperationType operation, Difficulty difficulty) {
    return (baseScore[operation]! * difficultyMultiplier[difficulty]!).round();
  }
  
  static int calculateComboBonus(int consecutiveCorrect) {
    return consecutiveCorrect * 5; // 연속 정답 보너스
  }
}
```

## 비행기 게임 구현 가이드

### 게임 오브젝트
```dart
class Airplane {
  double x; // 화면 가로 위치 (0.0 ~ 1.0)
  double y; // 화면 세로 위치 (고정: 0.8)
  double width = 0.1;
  double height = 0.1;
  
  Airplane({this.x = 0.5, this.y = 0.8});
  
  void moveLeft() => x = (x - 0.05).clamp(0.0, 1.0);
  void moveRight() => x = (x + 0.05).clamp(0.0, 1.0);
}

class FallingAnswer {
  final int value;
  final bool isCorrect;
  double x; // 가로 위치
  double y; // 세로 위치 (1.0에서 시작해서 0.0으로)
  final double speed = 0.01; // 떨어지는 속도
  
  FallingAnswer({
    required this.value,
    required this.isCorrect,
    required this.x,
    this.y = 1.0,
  });
  
  void update() => y -= speed;
  bool get isOffScreen => y < -0.1;
}
```

### 배경 요소
```dart
class BackgroundElement {
  final String type; // 'cloud', 'bird', 'star'
  double x, y;
  final double speed;
  
  BackgroundElement({
    required this.type,
    required this.x,
    required this.y,
    required this.speed,
  });
  
  void update() {
    y -= speed;
    if (y < -0.1) {
      y = 1.1;
      x = Random().nextDouble();
    }
  }
}
```

## 랭킹 시스템 구현

### 크로스 플랫폼 랭킹 서비스
```dart
abstract class LeaderboardService {
  Future<void> submitScore(GameScore score);
  Future<List<LeaderboardEntry>> getLeaderboard(GameMode mode);
}

class AndroidLeaderboardService implements LeaderboardService {
  // Google Play Games Services 구현
  @override
  Future<void> submitScore(GameScore score) async {
    // Play Games Services API 호출
  }
  
  @override
  Future<List<LeaderboardEntry>> getLeaderboard(GameMode mode) async {
    // 리더보드 데이터 조회
    return [];
  }
}

class IOSLeaderboardService implements LeaderboardService {
  // Game Center 구현
  @override
  Future<void> submitScore(GameScore score) async {
    // Game Center API 호출
  }
  
  @override
  Future<List<LeaderboardEntry>> getLeaderboard(GameMode mode) async {
    // Game Center 리더보드 조회
    return [];
  }
}
```

## UI/UX 구현 팁

### 반응형 디자인
```dart
class ResponsiveWidget extends StatelessWidget {
  final Widget mobile;
  final Widget tablet;
  
  const ResponsiveWidget({
    Key? key,
    required this.mobile,
    required this.tablet,
  }) : super(key: key);
  
  @override
  Widget build(BuildContext context) {
    return LayoutBuilder(
      builder: (context, constraints) {
        if (constraints.maxWidth < 600) {
          return mobile;
        } else {
          return tablet;
        }
      },
    );
  }
}
```

### 애니메이션 효과
```dart
class ScorePopupAnimation extends StatefulWidget {
  final int score;
  final VoidCallback onComplete;
  
  // 점수 획득 시 팝업 애니메이션
}

class AirplaneExplosionAnimation extends StatefulWidget {
  // 비행기 충돌 시 폭발 효과
}

class CorrectAnswerEffect extends StatefulWidget {
  // 정답 맞혔을 때 이펙트
}
```

## 성능 최적화

### 메모리 관리
- 게임 오브젝트 풀링 사용
- 이미지 캐싱 최적화
- 애니메이션 리소스 정리

### 배터리 최적화
- 불필요한 애니메이션 최소화
- 백그라운드에서 게임 일시정지
- 효율적인 렌더링

## 테스트 시나리오

### 단위 테스트
```dart
testWidgets('ProblemGenerator should create valid problems', (tester) async {
  final problem = ProblemGenerator.generate(
    OperationType.addition,
    Difficulty.oneDigit,
  );
  
  expect(problem.correctAnswer, equals(problem.operand1 + problem.operand2));
  expect(problem.options.length, equals(3));
  expect(problem.options.contains(problem.correctAnswer), isTrue);
});
```

### 통합 테스트
```dart
testWidgets('Complete classic game flow', (tester) async {
  // 로그인 → 게임 선택 → 플레이 → 결과 확인 전체 플로우 테스트
});
```
